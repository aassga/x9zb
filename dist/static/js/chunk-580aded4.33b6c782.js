(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-580aded4"],{"031f":function(t,s,e){"use strict";var i=function(){var t=this,s=t._self._c;return s("div",{attrs:{id:"chat-models"}},[s("input",{attrs:{id:"cp-input"}}),s("div",{staticClass:"ChatDetails_container"},[s("div",{staticClass:"header-list"},[s("span",{class:{on:0==t.ctp},on:{click:function(s){return t.changeType(0)}}},[t._v("广场")]),t.hideChat?t._e():s("span",{staticClass:"anchor",class:{on:2==t.ctp},on:{click:function(s){return t.changeType(2)}}},[s("img",{staticClass:"hot-tag",attrs:{src:e("cc25")}}),t._v(" 主播私聊 "),s("i",{directives:[{name:"show",rawName:"v-show",value:t.oneChat&&t.oneChat>0||t.inviteCount,expression:"oneChat && oneChat > 0||inviteCount"}],staticClass:"new-msg-icon"},[t._v(t._s(t.oneChat>99?"99+":t.inviteCount?1:t.oneChat))])]),s("span",{class:{on:1==t.ctp},on:{click:function(s){return t.changeType(1)}}},[t._v(" 聊天 "),s("i",{directives:[{name:"show",rawName:"v-show",value:t.msgCount&&t.msgCount>0,expression:"msgCount && msgCount > 0"}],staticClass:"new-msg-icon"},[t._v(t._s(t.msgCount>99?"99+":t.msgCount))])])]),t.pinInfo?s("div",{staticClass:"pin-info"},[s("i",{staticClass:"el-icon-message-solid"}),t._v(" "+t._s(t.pinInfo.text)+" ")]):t._e(),s("MessageList",{directives:[{name:"show",rawName:"v-show",value:1==this.ctp&&this.showChatList,expression:"this.ctp == 1&&this.showChatList"}],attrs:{activeIndex:t.activeIndex2,list:t.messageList},on:{onHandleClickItem:t.onHandleClickItem}}),t.roomInfo?[s("MessageInfo",{directives:[{name:"show",rawName:"v-show",value:1==this.ctp&&t.showMsgInfo,expression:"this.ctp == 1 && showMsgInfo"}],attrs:{dialogVisible:t.dialogVisible,isShowEmoji:t.isShowEmoji,modalMsgList:t.modalMsgList,roomInfo:t.roomInfo},on:{close:t.backList}})]:t._e(),s("div",{staticClass:"chat-window",class:{isChat:1===t.ctp},on:{click:function(s){return t.clearStatus()}}},[t._e(),0==t.ctp?s("div",{ref:"content-list",staticClass:"chat-detail-main"},t._l(t.msgList_0,(function(i,n){return s("div",{key:n},[[!i.channel||i.channel===t.channel||!t.channel&&"000"===i.channel?s("div",{staticClass:"other-side"},[s("div",{staticClass:"msg-box",on:{click:function(s){return t.console.log(i)}}},[s("div",{staticClass:"msg-container"},[s("div",{staticClass:"msg-content",class:{"anchor-msg":i.sender==t.parmUserInfo.user_id},on:{click:function(s){return s.stopPropagation(),t.showControl(n)}}},[i.text&&-1!==i.text.indexOf("进入直播间")?s("img",{staticClass:"hi-tag",attrs:{src:e("dd86")}}):t._e(),i.sender==t.parmUserInfo.user_id?s("span",{staticClass:"anchor-tag"},[t._v("主播")]):t._e(),i.sender_exp&&"gift"!==i.action&&i.sender!=t.parmUserInfo.user_id?s("span",{staticClass:"level-tag",class:"level"+(i.sender_exp?i.sender_exp:0)},[t._v("Lv."+t._s(i.sender_exp?i.sender_exp:0))]):t._e(),"gift"!==i.action?s("div",{staticClass:"text-name"},[t._v(t._s(i.sender_nickname?i.sender_nickname+":":""))]):t._e(),i.pic&&!i.text?[s("el-image",{staticClass:"pic-info",attrs:{"preview-src-list":[i.pic],fit:"cover",src:t._f("picFilter")(i.pic)}})]:t._e(),i.pic&&i.text?[s("div",{staticClass:"thumb-container",on:{click:function(s){return s.stopPropagation(),t.openLink(i.link)}}},[s("img",{staticClass:"thumb-pic",attrs:{src:t._f("picFilter")(i.pic)}}),s("div",{staticClass:"thumb-title"},[t._v(t._s(i.title))]),s("br"),s("div",{staticClass:"thumb-text"},[t._v(t._s(i.text))])])]:s("div",{staticClass:"text-info",domProps:{innerHTML:t._s(t.getText(i.text))}}),i.isError?s("i",{staticClass:"el-icon-warning error-msg",on:{click:function(s){return t.resend(i)}}}):t._e(),t.controlIndex===n?s("div",{staticClass:"msg-control other"},[s("div",{on:{click:function(s){return t.copyText(i)}}},[t._v(" 复制 "),s("i")])]):t._e()],2)])])]):t._e()]],2)})),0):t._e(),1==t.ctp?s("div",{ref:"content-list",staticClass:"chat-detail-main"},t._l(t.msgList_1,(function(e,i){return s("div",{key:i},[[!e.channel||e.channel===t.channel||!t.channel&&"000"===e.channel?s("div",{staticClass:"other-side"},[s("div",{staticClass:"msg-box"},[s("div",{staticClass:"msg-container"},[s("div",{staticClass:"msg-content",on:{click:function(s){return s.stopPropagation(),t.showControl(i)}}},[s("div",{staticClass:"text-name"},[t._v(t._s(e.sender_nickname)+":")]),e.pic&&!e.text?[s("el-image",{staticClass:"pic-info",attrs:{"preview-src-list":[e.pic],fit:"cover",src:t._f("picFilter")(e.pic)}})]:t._e(),e.pic&&e.text?[s("div",{staticClass:"thumb-container",on:{click:function(s){return s.stopPropagation(),t.openLink(e.link)}}},[s("img",{staticClass:"thumb-pic",attrs:{src:t._f("picFilter")(e.pic)}}),s("div",{staticClass:"thumb-title"},[t._v(t._s(e.title))]),s("br"),s("div",{staticClass:"thumb-text"},[t._v(t._s(e.text))])])]:s("div",{staticClass:"text-info",domProps:{innerHTML:t._s(t.getText(e.text))}}),e.isError?s("i",{staticClass:"el-icon-warning error-msg",on:{click:function(s){return t.resend(e)}}}):t._e(),t.controlIndex===i?s("div",{staticClass:"msg-control other"},[s("div",{on:{click:function(s){return t.copyText(e)}}},[t._v(" 复制 "),s("i")])]):t._e()],2)])])]):t._e()]],2)})),0):t._e(),2==t.ctp?s("div",{ref:"content-list",staticClass:"chat-detail-main"},t._l(t.msgList_2,(function(e,i){return s("div",{key:i,staticClass:"is-anchor"},[[!e.channel||e.channel===t.channel||!t.channel&&"000"===e.channel?s("div",{staticClass:"other-side"},[s("div",{staticClass:"msg-box"},[s("div",{staticClass:"msg-container"},[s("div",{staticClass:"msg-content",class:{"my-self":e.sender==t.parmUserInfo.user_id},on:{click:function(s){return s.stopPropagation(),t.showControl(i)}}},[e.sender!=t.parmUserInfo.user_id?s("div",{staticClass:"msg-avatar"},[s("img",{staticClass:"avatar",attrs:{src:e.avatar}})]):t._e(),e.pic&&!e.text?[s("el-image",{staticClass:"pic-info",attrs:{"preview-src-list":[e.pic],fit:"cover",src:t._f("picFilter")(e.pic)}})]:t._e(),e.pic&&e.text?[s("div",{staticClass:"thumb-container",on:{click:function(s){return s.stopPropagation(),t.openLink(e.link)}}},[s("img",{staticClass:"thumb-pic",attrs:{src:t._f("picFilter")(e.pic)}}),s("div",{staticClass:"thumb-title"},[t._v(t._s(e.title))]),s("br"),s("div",{staticClass:"thumb-text"},[t._v(t._s(e.text))])])]:t._e(),!e.pic&&e.text?s("div",{staticClass:"text-info",domProps:{innerHTML:t._s(t.getText(e.text))}}):t._e(),e.isError?s("i",{staticClass:"el-icon-warning error-msg",on:{click:function(s){return t.resend(e)}}}):t._e(),t.controlIndex===i?s("div",{staticClass:"msg-control other"},[s("div",{on:{click:function(s){return t.copyText(e)}}},[t._v(" 复制 "),s("i")])]):t._e()],2)])])]):t._e()]],2)})),0):t._e()]),s("div",{staticClass:"send-container"},[s("div",[s("svg",{staticClass:"emoji-btn",staticStyle:{"max-height":"30px"},attrs:{width:"30",height:"30",fill:"#c1c1c1",viewBox:"0 0 106.059 106.059"},on:{click:function(s){t.isShowEmoji=!t.isShowEmoji}}},[s("path",{attrs:{d:"M90.544 90.542c20.687-20.684 20.685-54.341.002-75.024-20.688-20.689-54.347-20.689-75.031-.006-20.688 20.687-20.686 54.346.002 75.034 20.682 20.684 54.341 20.684 75.027-.004zM21.302 21.3c17.494-17.493 45.959-17.495 63.457.002 17.494 17.494 17.492 45.963-.002 63.455-17.494 17.494-45.96 17.496-63.455.003-17.498-17.498-17.496-45.966 0-63.46zM27 69.865s-2.958-11.438 6.705-8.874c0 0 17.144 9.295 38.651 0 9.662-2.563 6.705 8.874 6.705 8.874C73.539 86.824 53.03 85.444 53.03 85.444S32.521 86.824 27 69.865zm6.24-31.194a6.202 6.202 0 1 1 12.399.001 6.202 6.202 0 0 1-12.399-.001zm28.117 0a6.202 6.202 0 1 1 12.403.001 6.202 6.202 0 0 1-12.403-.001z"}})]),0!=t.ctp?s("el-button-group",{staticClass:"msg-type-container"},[s("el-button",{attrs:{type:"primary",round:"",size:"mini"},on:{click:function(s){return t.sendImg(1)}}},[t._v("文字")]),s("el-button",{attrs:{type:"primary",round:"",size:"mini",icon:"el-icon-picture"},on:{click:function(s){return t.sendImg(2)}}})],1):t._e()],1),t.dialogVisible?s("div",{staticClass:"msg-arr"},[s("div",{staticClass:"ma-header"},[t._v(" 一键回复 "),s("i",{staticClass:"el-icon-close",on:{click:function(s){s.stopPropagation(),t.dialogVisible=!1}}})]),t._l(t.modalMsgList,(function(e,i){return s("div",{key:i},[s("div",{on:{click:function(s){return s.stopPropagation(),t.setMsg(e)}}},[t._v(" "+t._s(JSON.parse(e.content).text)+" "),s("i",{staticClass:"el-icon-delete-solid",on:{click:function(s){return s.stopPropagation(),t.delQuickReply(e)}}})])])}))],2):t._e(),1==t.msgType?s("textarea",{directives:[{name:"model",rawName:"v-model",value:t.msgText,expression:"msgText"}],ref:"msg",attrs:{id:"msg",type:"text",placeholder:"请输入聊天内容",rows:"1"},domProps:{value:t.msgText},on:{keyup:function(s){return!s.type.indexOf("key")&&t._k(s.keyCode,"enter",13,s.key,"Enter")?null:t.sendMsg.apply(null,arguments)},input:function(s){s.target.composing||(t.msgText=s.target.value)}}}):t._e(),2==t.msgType?s("div",{staticClass:"add-img-container"},[s("form",{ref:"mf",attrs:{id:"msgForm",method:"post",enctype:"multipart/form-data"}},[s("input",{attrs:{type:"file",id:"fileUp",name:"pic"},on:{change:t.changeFile}})]),t.prevImg?s("img",{attrs:{src:t.prevImg}}):s("span",{staticClass:"add-img"},[t._v("添加图片")])]):t._e(),s("div",{staticClass:"control-footer"},[s("div",{class:[0!=t.ctp||t.token?"send":"no_send"],on:{click:t.sendMsg}},[t._v("发送")])])]),s("div",{staticClass:"emoji-box"},[s("VEmojiPicker",{directives:[{name:"show",rawName:"v-show",value:t.isShowEmoji,expression:"isShowEmoji"}],on:{select:t.selectEmoji}})],1)],2)])},n=[],o=(e("14d9"),e("3c65"),e("1c32")),a=function(){var t=this,s=t._self._c;return s("div",{staticClass:"HuyaXWebhMessagelist"},t._l(t.list,(function(i,n){return s("div",{key:n,class:["HuyaXWebhMessagelist_i",t.activeIndex==n?"active":""],on:{click:function(s){return t.onHandleClickItem(i,n)}}},[s("div",{staticClass:"HuyaXWebhMessagelist_i_avater_box"},[s("img",{staticClass:"HuyaXWebhMessagelist_i_avater",attrs:{src:i.avater||e("3f2d"),alt:"",srcset:""}}),s("div",{directives:[{name:"show",rawName:"v-show",value:i.unread_count&&i.unread_count>0,expression:"item.unread_count && item.unread_count > 0"}],staticClass:"HuyaXWebhMessagelist_i_avater_tips"},[t._v(t._s(i.unread_count>99?"99+":i.unread_count))])]),s("div",{staticClass:"HuyaXWebhMessagelist_i_context"},[s("div",{staticClass:"HuyaXWebhMessagelist_i_context_t"},[s("div",{staticClass:"HuyaXWebhMessagelist_i_context_t_name"},[t._v(t._s(i.name||"未知"))]),s("div",{staticClass:"HuyaXWebhMessagelist_i_context_t_date"},[t._v(t._s(i.last_msg?i.last_msg.creation_time:"未知"))])]),s("div",{staticClass:"HuyaXWebhMessagelist_i_context_b"},[t._v(t._s(i.last_msg?i.last_msg.text:"未知"))])])])})),0)},c=[],r={name:"HuyaXWebhMessagelist",props:["list","activeIndex"],data(){return{}},mounted(){},methods:{onHandleClickItem(t,s){this.$emit("onHandleClickItem",t,s)}}},l=r,h=(e("29f3"),e("0c7c")),d=Object(h["a"])(l,a,c,!1,null,"32b16998",null),m=d.exports,p=function(){var t=this,s=t._self._c;return s("div",{staticClass:"HuyaXWebhMessageinfo"},[s("div",{staticClass:"HuyaXWebhMessageinfo_title"},[s("img",{staticClass:"HuyaXWebhMessageinfo_title_icon",attrs:{src:e("3ecf")},on:{click:t.onHandleBack}}),t._v(" "+t._s(t.roomInfo.name||"未知")+" ")])])},g=[],u={name:"HuyaXWebhMessageinfo",props:["roomInfo"],data(){return{}},mounted(){},methods:{onHandleBack(){this.$emit("close")}}},f=u,v=(e("740e"),Object(h["a"])(f,p,g,!1,null,"440dd3d4",null)),_=v.exports,C={name:"ChatDetails",props:["hideChat","qsVid","giftList"],components:{MessageList:m,MessageInfo:_},data(){return{msgList2:[],oneChat:0,msgCount:0,modalMsgList:[],showMsgInfo:!1,messageList:[],activeIndex2:0,roomInfo:{},isReadOnly:!1,msgText:"",msgList_0:[],msgList_1:[],msgList_2:[],myUserinfo:{uid:""},fd:"",isShowGiftBox:!1,giftNum:1,currentGiftId:"",isShowEmoji:!1,uid:"",vid:"",info:{token:""},initInvite:!0,dialogVisible:!1,gift_jpg:"",targetUserInfo:{},isAllowedSendMsg:!0,hasSendMsgCount:0,needBuy:!1,that:this,active:0,ws:"",WSURL:"",msgType:1,lockReconnect:!1,timeout:6e3,timeoutObj:null,serverTimeoutObj:null,timeoutnum:null,imUserInfo:null,vid:"0DE7F2AD0706AD723BBD06F0B58EEE87",inRoom:!1,parmUserInfo:{user_id:19,username:"手机用户8",vid:"12"},formData:{},controlIndex:-1,pinInfo:"",page:1,ctp:0,inviteCount:0,prevImg:null,showChatList:!1,isMore:!0,newMsg:{oneChat:!1,groupChat:!1},room_type:"",channel:localStorage.getItem("channel"),showLoading:!0,initChatTab:!0,initTab:!0,leaveVid:"",type0_local_msg_list:[],type2_local_msg_list:[]}},computed:{token(){return this.$store.state.user.islogin}},watch:{msgList2:{handler(t,s){console.log("未读消息列表数据变化"),console.log(t),console.log("消息列表的数据"),console.log(this.messageList),this.messageList=this.mapList(this.messageList,t),this.onHandleGroupMsgChange(this.messageList),this.$forceUpdate()},deep:!0},fd(t,s){t!=s&&(console.log(99999999),this.inviteRoom(!0))},showLoading(t,s){t||this.toBottom()},ctp(t,s){1==t&&this.getMessageList(),t!=s&&(this.initTab=!0),2==s&&this.leaveRoom(2)}},filters:{picFilter(t){let s=t;if(t.includes("base64")){let t=window.location.hostname.includes("10")?"http://lukee.huya.com/upload/":window.location.origin+"/";s=s.replace(t,"")}return s}},updated(){this.toBottom()},async mounted(){const t=document.querySelector(".chat-window");t.addEventListener("scroll",s=>{if(console.log(t.scrollTop,"domScroll.scrollTop-domScroll.offsetHeight==="),t.scrollTop<=2&&this.isMore){if(this.page++,1==this.ctp&&this.initChatTab)return void(this.initChatTab=!1);this.getChatHistoryMsg(this.initTab?1:"")}}),console.log(this.qsVid,"this.qsVid=============="),this.vid=this.qsVid||"";let s="";const e=JSON.parse(localStorage.getItem("userInfo"));this.info=e||{token:""},Object(o["a"])()&&(e?this.parmUserInfo={user_id:e.id,username:e.user_nickname,vid:this.vid,type:e.user_type}:localStorage.getItem("userid")?this.parmUserInfo={user_id:localStorage.getItem("userid"),username:localStorage.getItem("userid"),vid:this.vid,type:0}:(s=1e7+Math.random().toString().slice(-6),localStorage.setItem("userid",s),this.parmUserInfo={user_id:s,username:s,vid:this.vid,type:0})),this.getMessageList(),this.initToken(!0)},created(){this.uid=this.$route.query.id},beforeDestroy(){this.$store.dispatch("chatInOut",{touid:this.uid,dateline:(new Date).getTime(),status:2})},methods:{resend(t){console.log(t),this.handleLocalMsgList(this.ctp).map((s,e)=>{s==t&&(this.handleLocalMsgList(this.ctp).splice(e,1),console.log(this.msgList))}),this.msgText=t.text},sendImg(t){this.msgType=t},changeFile(){const t=document.querySelector("#fileUp"),s=t.files[0];this.formData.pic=s;var e=new FileReader;e.readAsDataURL(s);const i=this;e.onload=function(t){var s=this.result;i.prevImg=s}},mapList(t,s){if(s.length>0&&s[s.length-1].text){t.sort((t,e)=>t.vid==s[s.length-1].vid?-1:e.vid==s[s.length-1].vid?1:0);for(let s=0;s<t.length;s++){let e=t[s];e.vid==this.roomInfo.vid&&(this.activeIndex2=s)}}let e=t,i=s;for(let n=0;n<e.length;n++){let t=e[n];for(let s=0;s<i.length;s++){let e=i[s];e.vid==t.vid&&(t.unread_count=e.unread_count,e.text&&(t.last_msg.text=e.text))}}return console.log("新消息变更之后的数组"),console.log(e),e},onHandleGroupMsgChange(t){let s=0;for(let e=0;e<t.length;e++){const i=t[e];i.unread_count>0&&(s+=i.unread_count)}this.msgCount=s},onHandleMsgChange(t){let s=0;for(let e=0;e<t.length;e++){const i=t[e];i.unread_count>0&&(s+=i.unread_count)}this.oneChat=s},onHandleUnRead(t,s){if(0==s)console.log("默认的未读消息数组"),console.log(t),this.msgList2=t;else{let s=!0,e=JSON.parse(JSON.stringify(this.msgList2));for(let i=0;i<e.length;i++){let n=e[i];n.vid===t.vid&&(s=!1,n.unread_count+=1,n.text=t.text)}s&&e.push(t),console.log("我接受到了新消息"),console.log(e),this.msgList2=e,this.msgCount+=1}},openLink(t){window.open(t)},readItem(t){let s=this.msgList2;for(let e=0;e<s.length;e++){let i=s[e];i.vid==t.vid&&(i.unread_count=0)}this.msgList2=s},initToken(t=!1){const s=this;this.$store.dispatch("getImToken",this.parmUserInfo).then(t=>{s.imUserInfo=t.data,s.newSocket(t.data)})},backList(){this.showChatList=!0,this.msgList=[],this.roomInfo=!1,this.showLoading=!0,this.showMsgInfo=!1,this.getMessageList(),"2"==this.room_type&&this.leaveRoom(2),this.room_type=""},delQuickReply(t){this.$store.dispatch("delQuickReply",{user_id:t.user_id,id:t.id}).then(t=>{"成功"==t.msg&&(this.$message({type:"success",message:"删除成功"}),this.quickReplyList())})},setMsg(t){this.msgText=JSON.parse(t.content).text,this.dialogVisible=!1},quickReplyList(){this.$store.dispatch("getQuickReplyList",{user_id:this.parmUserInfo.user_id}).then(t=>{this.modalMsgList=t.data,this.dialogVisible=!0,this.controlIndex=""})},async getMessageList(){let t=await this.$store.dispatch("getMessageList",{id:this.parmUserInfo.user_id,type:"1,2"});if(this.showLoading=!1,0==t.code){for(let s=0;s<t.data.length;s++){let e=t.data[s];e.unread_count=0}console.log("请求拿到的数据"),console.log(t.data),this.msgList2.length>0&&(t.data=this.mapList(t.data,this.msgList2),this.onHandleGroupMsgChange(t.data)),this.messageList=t.data}},saveMsg(){if(!this.msgText)return;this.$store.dispatch("addQuickReply",{user_id:this.parmUserInfo.user_id,text:this.msgText}).then(t=>{0==t.code&&this.$message({type:"success",message:"保存成功"})})},selectEmoji(t){var s=document.getElementById("msg"),e=s.selectionStart,i=s.selectionEnd;if(void 0!==e&&void 0!==i){var n=this.msgText.substring(0,e)+t.data+this.msgText.substring(i);this.isShowEmoji=!1,this.msgText=n}},getText(t){if(t){var s=/(https?:\/\/[^\s]+)/g;return t=t.replace(s,"<a style='text-decoration:underline;color:blue' target='_blank' href='$1'>$1</a>"),t=t.replace(/\r\n/g,"<br>"),t=t.replace(/\n/g,"<br>"),t=t.replace(/\r/g,"<br>"),t}},onHandleClickItem(t,s){console.log(t,"item-info======="),this.page=1,this.handleLocalMsgList(this.ctp,"empty"),this.roomInfo=t,this.activeIndex2=s,this.msgCount-=this.messageList[s].unread_count||0,this.messageList[s].unread_count=0,this.readItem(t),this.parmUserInfo.vid=t.vid,this.room_type=t.room_type,this.showChatList=!1,this.showMsgInfo=!0,this.inRoomInfo(this.fd)},leaveRoom(){this.roomInfo={};const t={vid:this.leaveVid,token:this.imUserInfo.token,fd:this.fd,type:1==this.ctp?this.room_type:2};this.$store.dispatch("leaveRoom",t).then(t=>{})},copyText(t){const s=t.text,e=document.getElementById("cp-input");e.value=s,e.select();let i=document.createRange(),n=document.getSelection();i.selectNode(e),n.addRange(i),e.setSelectionRange(0,e.value.length);let o=document.execCommand("copy");o&&(this.$alert("复制成功","提示"),this.tipsId="")},changeType(t){if(this.pinInfo="",this.showLoading)return;if(this.ctp==t)return;this.ctp=t,this.page=1,this.showLoading=!0,1==t?(this.newMsg.groupChat=!1,this.showChatList=!0):this.backList();const s=this.qsVid;if(this.controlIndex=-1,0==t)this.parmUserInfo.vid=s,this.inRoomInfo(this.fd),this.handleLocalMsgList(0);else{if(2==t){this.inviteCount=0,this.handleLocalMsgList(2),this.newMsg.oneChat=!1;let t=JSON.parse(localStorage.getItem("vidInfo"))||{};if(!t.hasOwnProperty(s))return void this.inviteRoom();this.parmUserInfo.vid=t[s],this.inviteRoom()}this.showChatList||this.inviteRoom()}},clearStatus(){this.controlIndex=-1},inviteRoom(t=!1){if(!this.fd)return;const s=this.qsVid;let e=JSON.parse(localStorage.getItem("vidInfo"))||{};this.$store.dispatch("inviteRoom",{type:t?2:this.ctp,is_new:1,token:this.imUserInfo.token,fd:this.fd,name:this.parmUserInfo.username,user_id:Object(o["a"])().uid,channel:this.channel}).then(t=>{if(this.initInvite)return this.initInvite=!1,e[s]=t.data.vid,void localStorage.setItem("vidInfo",JSON.stringify(e));this.parmUserInfo.vid=t.data.vid,e[s]=t.data.vid,localStorage.setItem("vidInfo",JSON.stringify(e)),this.inRoomInfo(this.fd),this.controlIndex=""})},getChatHistoryMsg(t){console.log(t,"========getChatHistoryMsg");this.showLoading=!0;let s={page:t||this.page,limit:20,type:1==this.ctp?this.room_type:this.ctp||0,vid:this.parmUserInfo.vid,user_id:this.parmUserInfo.user_id};this.$store.dispatch("getChatHistory",s).then(t=>{let e=t.data.reverse();this.showLoading=!1,this.initTab=!1,0!==e.length?(console.log(s.page),this.handleLocalMsgList(2==s.type&&1==this.ctp?1:s.type,1!=s.page?"unshift":"init",e)):this.isMore=!1}).catch(t=>{this.showLoading=!1})},showControl(t){this.controlIndex!=t?this.controlIndex=t:this.controlIndex=-1},inRoomInfo(t){1!=this.ctp&&2!=this.ctp||(this.leaveVid=this.parmUserInfo.vid);const s={vid:this.parmUserInfo.vid,token:this.imUserInfo.token,fd:t,type:1==this.ctp?this.room_type:this.ctp||0,channel:this.channel},e=this;this.$store.dispatch("inRoom",s).then(t=>{console.log("inRoom的数据"),console.log(t),t.data.pinData&&""!=t.data.pinData&&(e.pinInfo={text:t.data.pinData}),e.inRoom=!0,e.getChatHistoryMsg(1)})},newSocket(t){const s="http:"==window.location.protocol?"ws://":"wss://";this.WSURL=`${s}${window.location.hostname.includes("10")?"10.83.107.92:9021":window.location.hostname}${window.location.protocol,"/wss/"}?token=${t.token}&tokenid=${t.id}&vid=${this.qsVid}`,this.ws=new WebSocket(this.WSURL),this.ws.onopen=this.websocketonopen,this.ws.onerror=this.websocketonerror,this.ws.onclose=this.websocketclose,this.ws.onmessage=this.websocketonmessage},websocketonopen(){this.start()},websocketonerror(){console.log("出现错误"),this.reconnect()},websocketclose(t){console.log("断开连接",t),this.ws.close(),this.reconnect()},reconnect(){if(this.lockReconnect)return;this.lockReconnect=!0,this.timeoutnum&&clearTimeout(this.timeoutnum);const t=this;this.timeoutnum=setTimeout(()=>{t.initToken(),t.initInvite=!0,t.lockReconnect=!1},5e3)},reset(){clearTimeout(this.timeoutObj),clearTimeout(this.serverTimeoutObj),this.start()},start(){this.timeoutObj&&clearTimeout(this.timeoutObj),this.serverTimeoutObj&&clearTimeout(this.serverTimeoutObj);let t=0;this.heart(t)},heart(t){this.timeoutObj=setTimeout(()=>{if(1==this.ws.readyState){let t="heart";this.ws.send(t)}this.heart(t)},this.timeout)},sendMsgByApi(t,s){let e={vid:this.parmUserInfo.vid,fd:this.fd,type:1==this.ctp?this.room_type:this.ctp||0,text:s,method:"notice",msg_type:0==this.ctp?0:1,color:"#000",sender:this.parmUserInfo.user_id,token:this.imUserInfo.token,channel:this.channel};if(2===this.ctp&&(e.receiver=Object(o["a"])().uid),2==this.msgType){var i=new FormData;i.append("vid",this.parmUserInfo.vid),i.append("fd",this.fd),i.append("title",""),i.append("link",""),i.append("type",1==this.ctp?this.room_type:this.ctp||0),i.append("method","notice"),i.append("msg_type",2),i.append("color","#000"),i.append("sender",this.parmUserInfo.user_id),i.append("token",this.imUserInfo.token),i.append("channel",this.channel),i.append("pic",this.formData.pic),i.append("text",""),e=i}this.$store.dispatch("sendMessage",e).then(s=>{"connection error"==s.msg&&this.initToken(),0==s.code||(this.handleLocalMsgList(this.ctp).find((function(s){return s.uiCode==t})).isError=!0),this.toBottom()}).catch(s=>{this.handleLocalMsgList(this.ctp).find((function(s){return s.uiCode==t})).isError=!0}).finally(t=>{this.msgText="",this.formData.pic="",this.prevImg=null})},sendMsg(){if(this.isShowEmoji=!1,0==this.ctp&&!this.token)return void this.$message({type:"error",message:"未登录不能在直播间发言~"});if(!this.isAllowedSendMsg||""==this.msgText){if(2==this.msgType){let t=this.msgText;console.log(this.msgText,t,"=======this.msgText"),this.msgText="",console.log(this.msgText,t,"=======this.msgText2"),this.sendMsgByApi(null,t)}return}let t=(new Date).getTime(),s={avatar:this.info.avatar,sender:this.parmUserInfo.user_id,sender_nickname:this.info.user_nickname,sender_exp:this.info.exp,text:this.msgText,uiCode:t,isError:!1};this.handleLocalMsgList(this.ctp).push(s),this.sendMsgByApi(t,this.msgText),this.msgText=""},websocketonmessage(t){let s=JSON.parse(t.data);if(null!==s.fd&&"open"===s.action&&(this.fd=s.fd,this.inRoomInfo(s.fd)),"delmsg"===s.action){let t=this.handleLocalMsgList(this.ctp),e=t.findIndex(t=>1*t.msg_id===1*s.msg_id);t.splice(e,1),this.handleLocalMsgList(this.ctp,"init",t)}if("clearHistory"===s.action&&this.handleLocalMsgList(this.ctp,"empty"),"newRoom"===s.action&&(2!=this.ctp&&"2"===s.room_type&&(this.inviteCount=this.inviteCount+1),s.fd!=this.fd&&("2"===s.room_type&&(this.newMsg.oneChat=!0),"1"===s.room_type&&(this.newMsg.groupChat=!0,this.msgCount++))),"unread"===s.action){let t=s.data||[];this.onHandleUnRead(t,0)}if("newMsg"===s.action){let t={vid:s.newMsgRoomvid,room_type:s.room_type,unread_count:1,text:s.text};this.onHandleUnRead(t,1)}if("send"===s.action&&"0"===s.msg_type){let t={messageForShow:s.text,textContent:s.text};this.$store.commit("setdanmakuShow",t)}if("pin"===s.action&&("1"==s.pin&&(this.pinInfo=JSON.parse(s.data)),this.pinInfo.msg_id=s.msg_id,"2"==s.pin&&(this.pinInfo="")),"send"===s.action){if(s.sender_nickname==this.info.user_nickname)return;if(s.sender_nickname.includes("游客")&&0==this.ctp)return;this.handleLocalMsgList(this.ctp,"push",s),this.toBottom()}if("system"===s.action){if(s.text.includes("进入直播间")&&0!=this.ctp)return;this.handleLocalMsgList(this.ctp,"push",s)}if("gift"===s.action){if(0!=this.ctp)return;let t=this.giftList.filter(t=>t.id==s.gift_id)[0];s.text=`感谢${s.sender_nickname}送了${t.giftname}`,this.handleLocalMsgList(this.ctp,"push",s),this.$emit("onhandleSendGift",s)}200==s.status&&s.data&&("dialog"==s.data.type&&(this.handleLocalMsgList(this.ctp,"init",s.data.historyMessageList),this.myUserinfo=s.data.targetUserInfo,this.fd=s.data.targetUserInfo.fd),"call"==s.data.type&&(1==s.data.content.type&&(this.handleLocalMsgList(this.ctp).push({...s.data.content,uid:this.userInfo.uid}),this.msgText="",this.toBottom(),this.hasSendMsgCount>0&&(this.hasSendMsgCount=this.hasSendMsgCount-1)),2==s.data.content.type&&(this.handleLocalMsgList(this.ctp).push({...s.data.content,uid:this.userInfo.uid}),this.toBottom())),"message"==s.data.type&&(this.$store.dispatch("getUnReadMsgNum"),1==s.data.content.type&&(this.handleLocalMsgList(this.ctp).push({...s.data.content,uid:this.uid}),this.msgText="",this.toBottom()),2==s.data.content.type&&(this.handleLocalMsgList(this.ctp).push({...s.data.content,uid:this.uid}),this.toBottom())))},toBottom(){let t=document.querySelector(".chat-window"),s=document.querySelector(".chat-detail-main");t.scrollTop=s.clientHeight-t.clientHeight+500},handleLocalMsgList(t,s,e){if(console.log(t,s,e),console.log("ddddddddddddddddddddddddd"),t==this.ctp)return 0==t?("init"==s&&(this.msgList_0=e),"push"==s&&this.msgList_0.push(e),"unshift"==s&&this.msgList_0.unshift(e),"empty"==s&&(this.msgList_0=[]),this.msgList_0):2==t?("init"==s&&(this.msgList_2=e),"push"==s&&this.msgList_2.push(e),"empty"==s&&(this.msgList_2=[]),this.msgList_2):1==t?("init"==s&&(this.msgList_1=e),"push"==s&&this.msgList_1.push(e),"unshift"==s&&this.msgList_1.unshift(e),"empty"==s&&(this.msgList_1=[]),this.msgList_1):void 0}}},y=C,w=(e("f672"),Object(h["a"])(y,i,n,!1,null,"2ed384ea",null));s["a"]=w.exports},"1c32":function(t,s,e){"use strict";function i(){const t={},s=window.location.search.split("?")[1],e=decodeURIComponent("?"+s),i=""!==e?e.substr(1).split("&"):[];return i.forEach(s=>{if(s){const e=s.split("=");t[e[0]]=e[1]}}),t}e.d(s,"a",(function(){return i}))},"29f3":function(t,s,e){"use strict";e("62c7")},"31bc":function(t,s,e){"use strict";var i=function(){var t=this,s=t._self._c;return s("div",{staticClass:"donwnload-modal",on:{click:function(s){return s.stopPropagation(),t.onHandleClose.apply(null,arguments)}}},[s("div",{staticClass:"dialog-context",on:{click:function(t){return t.stopPropagation(),(()=>{}).apply(null,arguments)}}},[s("img",{staticClass:"dialog-context-img",attrs:{src:e("e1ca")},on:{click:function(s){return s.stopPropagation(),t.onHandleGoDownLoadPage.apply(null,arguments)}}}),s("img",{staticClass:"dialog-context-icon",attrs:{src:e("1108")},on:{click:function(s){return s.stopPropagation(),t.onHandleClose.apply(null,arguments)}}})])])},n=[],o=(e("14d9"),{name:"downLoadModel",data(){return{}},computed:{},watch:{},mounted(){},methods:{onHandleClose(){this.$emit("close")},onHandleGoDownLoadPage(){this.$emit("close"),this.$router.push("/downLoad")}}}),a=o,c=(e("cf87"),e("0c7c")),r=Object(c["a"])(a,i,n,!1,null,"0fffc3a4",null);s["a"]=r.exports},"39e5":function(t,s,e){},"62c7":function(t,s,e){},"740e":function(t,s,e){"use strict";e("39e5")},ab15:function(t,s,e){},bf74:function(t,s,e){},cf87:function(t,s,e){"use strict";e("ab15")},f358:function(t){t.exports=JSON.parse('["[微笑]","[撇嘴]","[色]","[发呆]","[得意]","[流泪]","[害羞]","[闭嘴]","[睡]","[大哭]","[尴尬]","[发怒]","[调皮]","[龇牙]","[惊讶]","[难过]","[酷]","[冷汗]","[抓狂]","[吐]","[偷笑]","[可爱]","[白眼]","[傲慢]","[饥饿]","[困]","[惊恐]","[流汗]","[憨笑]","[大兵]","[奋斗]","[咒骂]","[疑问]","[嘘]","[晕]","[折磨]","[衰]","[骷髅]","[敲打]","[再见]","[擦汗]","[抠鼻]","[鼓掌]","[糗大了]","[坏笑]","[左哼哼]","[右哼哼]","[哈欠]","[鄙视]","[委屈]","[快哭了]","[阴险]","[亲亲]","[吓]","[可怜]","[菜刀]","[西瓜]","[啤酒]","[篮球]","[乒乓]","[咖啡]","[饭]","[猪头]","[玫瑰]","[凋谢]","[示爱]","[爱心]","[心碎]","[蛋糕]","[闪电]","[炸弹]","[刀]","[足球]","[瓢虫]","[便便]","[月亮]","[太阳]","[礼物]","[拥抱]","[强]","[弱]","[握手]","[胜利]","[抱拳]","[勾引]","[拳头]","[差劲]","[爱你]","[NO]","[OK]","[爱情]","[飞吻]","[跳跳]","[发抖]","[怄火]","[转圈]","[磕头]","[回头]","[跳绳]","[挥手]","[激动]","[街舞]","[献吻]","[左太极]","[右太极]"]')},f672:function(t,s,e){"use strict";e("bf74")}}]);